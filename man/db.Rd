% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/db.R
\name{connect_db}
\alias{connect_db}
\alias{disconnect_db}
\alias{glims_tbl}
\alias{glims_join_tbl}
\alias{preview}
\alias{oracle_julian_to_datetime}
\alias{datetime_to_oracle_julian}
\alias{build_query}
\alias{retrieve}
\alias{get_glims_data}
\alias{original_query}
\title{GLIMS Database Access}
\usage{
connect_db(db = "Oracle")

disconnect_db(con)

glims_tbl(con, table_name, schema = "ORAGLIMS")

glims_join_tbl(
  qry,
  table_name,
  by = NULL,
  ...,
  type = "left",
  schema = "ORAGLIMS"
)

preview(qry, n = 100)

oracle_julian_to_datetime(x, tz = "Europe/Amsterdam")

datetime_to_oracle_julian(x)

build_query(con, qry_type)

retrieve(
  qry,
  limit = Inf,
  convert_julian = TRUE,
  convert_logicals = TRUE,
  convert_column_names = TRUE
)

get_glims_data(
  date_range,
  ...,
  convert_julian = TRUE,
  convert_logicals = TRUE,
  convert_column_names = TRUE,
  limit = Inf,
  qry_type = c("results", "orders"),
  db = "Oracle"
)

original_query(x)
}
\arguments{
\item{db}{Database to connect to.}

\item{con}{Connection object.}

\item{table_name}{Name of the table to query.}

\item{schema}{Database schema; the upper structure name of \code{table_name}.}

\item{qry}{A \code{tbl_dbi} object representing the database query.}

\item{by}{Column name(s) to join by. Can be a named vector to allow different names:\cr  \code{by = c("col_A" = "col_B")}.}

\item{...}{.  * \code{\link[=get_glims_data]{get_glims_data()}}: Arguments passed on the \code{WHERE} clause in the query. Supports \code{dplyr} language.
\itemize{
\item \code{\link[=glims_join_tbl]{glims_join_tbl()}}: Arguments passed on the join functions.
}}

\item{type}{Direction of the join, defaults to \code{"left"}.
\itemize{
\item \code{\link[dplyr:mutate-joins]{"inner"}}: returns matched x rows.
\item \code{\link[dplyr:mutate-joins]{"left"}}: returns all x rows.
\item \code{\link[dplyr:mutate-joins]{"right"}}: returns matched of x rows, followed by unmatched y rows.
\item \code{\link[dplyr:mutate-joins]{"full"}}: returns all x rows, followed by unmatched y rows.
}}

\item{n}{Number of rows to collect.}

\item{x}{Numeric vector or data.frame, to convert Oracle Julian days to common dates. In case of data frames, only columns with numeric values that have Julian days between 1900-01-01 and 2100-01-01 will be converted.}

\item{tz}{Target time zone.}

\item{qry_type}{Type of query, see \verb{Query Types} below.}

\item{limit}{Maximum number of rows to return. The end result will probably have fewer results due to post-process data cleaning; the \code{limit} setting only applies to the original database query.}

\item{convert_julian}{Logical, whether to convert Oracle Julian date fields to Date or POSIXct.}

\item{convert_logicals}{Logical, whether to convert binary numeric fields (0/1) to logicals.}

\item{convert_column_names}{Logical, whether to rename column names using a lookup table from the package.}

\item{date_range}{Date range, can be length 1 or 2 (or more to use the min/max) to filter the \code{ORD_RECEIPTTIME} column. Supports date/time, date, and years. Use \code{NULL} to set no date filter.}
}
\value{
Returns a live \code{DBIConnection} object that can be used with \code{DBI}, \code{dplyr}, or \code{dbplyr} for querying and manipulating data.
}
\description{
Establishes a connection to the GLIMS Oracle database using environment variables for all configuration parameters. This function is designed for use in secure environments such as Posit Workbench, where credentials and driver paths are stored outside the source code.
}
\section{Environment Variables}{


When \code{db} is set to \code{"Oracle"}, the following environment variables must be defined before using this function:
\itemize{
\item \strong{\code{MMBI_EPIDS_DRIVER}} - Full path to, or name of, the Oracle ODBC driver shared library
\item \strong{\code{MMBI_EPIDS_HOST}} - Hostname or IP address of the Oracle database server
\item \strong{\code{MMBI_EPIDS_PORT}} - Port number for the Oracle service (typically \code{1521})
\item \strong{\code{MMBI_EPIDS_SVC}} - Oracle Service Name (SVC) or SID identifying the database instance
\item \strong{\code{MMBI_EPIDS_USER}} - Oracle database username
\item \strong{\code{MMBI_EPIDS_PASS}} - Oracle database password
}

The environment variables are read at runtime using \code{Sys.getenv()} and passed to \code{\link[DBI:dbConnect]{DBI::dbConnect()}}. This approach ensures credentials are never exposed in the source code or logs.
}

\section{Query Types}{

Various query types have been defined:
\itemize{
\item \code{"orders"}: 1 row per order, info about request (department, ward, room, etc.)
\item \code{"results"}: 1 row per result, can be multiple in an order
\item \code{"isolates"}: 1 row per isolate, can be multiple in a result
}

These types can be combined.
}

\examples{
\dontrun{

# Opening Connection ---------------------------------------------------

# open connection and save as object
conn <- connect_db()

# connect to a table
conn |>
  glims_tbl("ANTIBIOTICRESULT")


# Running Queries ------------------------------------------------------

library(dplyr)

# download first 500 rows
first_500 <- conn |>
  glims_tbl("ANTIBIOTICRESULT") |>
  retrieve(500)

# dplyr functions are automatically translated into SQL
conn |>
  glims_tbl("ANTIBIOTICRESULT") |>
  filter(ABRS_RISRAWVALUE == 3) |>
  show_query() # use collect() or retrieve() instead to download

# more advanced queries can still run server-side
my_count <- conn |>
  glims_tbl("ANTIBIOTICRESULT") |>
  filter(ABRS_RISRAWVALUE == 3) |>
  count(ABRS_RISREPORTVALUECHANGED) |>
  show_query() |> # first show query
  collect()       # then immediately run and download data

# join to other columns server-side
conn |>
  glims_tbl("ANTIBIOTICRESULT") |>
  glims_join_tbl("ANOTHERTABLE", by = "some_column") |>
  show_query()


# Closing Connection ---------------------------------------------------

disconnect_db(conn)

}


# Other ----------------------------------------------------------------

datetime_to_oracle_julian(Sys.Date())

Sys.Date()
Sys.Date() |> datetime_to_oracle_julian() |> oracle_julian_to_datetime()

Sys.time()
Sys.time() |> datetime_to_oracle_julian() |> oracle_julian_to_datetime()
Sys.time() |> datetime_to_oracle_julian() |> oracle_julian_to_datetime(tz = "UTC")
}
\seealso{
\code{\link[DBI:dbConnect]{DBI::dbConnect()}}, \code{\link[odbc:dbConnect-OdbcDriver-method]{odbc::odbc()}}
}
